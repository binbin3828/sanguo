# 三国霸业 - 外交系统详细设计文档

## 文档说明

本文档详细描述《三国霸业》外交系统的所有指令逻辑、成功率计算和交互流程。

---

## 一、外交指令总览

外交指令用于对其他势力进行情报操作和人员策反，需要派遣武将到其他势力的城市执行。

### 1.1 指令分类

| 指令ID | 指令名称 | 消耗体力 | 主要效果 | 目标要求 |
|--------|----------|----------|----------|----------|
| 15 | 离间(ALIENATE) | 4 | 降低忠诚度 | 敌方武将 |
| 16 | 招揽(CANVASS) | 4 | 招募人才 | 其他势力武将 |
| 17 | 策反(COUNTERESPIONAGE) | 4 | 使其独立 | 敌方太守 |
| 18 | 反间(REALIENATE) | 4 | 增加敌意 | 未实现 |
| 19 | 劝降(INDUCE) | 4 | 使势力归降 | 敌方君主 |

### 1.2 指令常量定义

```typescript
// 外交指令常量
const ORDER_ALIENATE = 15;               // 离间
const ORDER_CANVASS = 16;                // 招揽
const ORDER_COUNTERESPIONAGE = 17;       // 策反
const ORDER_REALIENATE = 18;             // 反间（未实现）
const ORDER_INDUCE = 19;                 // 劝降

// 外交指令消耗体力
const DIPLOMACY_CONSUME_THEW = 4;        // 所有外交指令消耗4点体力

// 外交指令冷却时间（月）
const DIPLOMACY_COOLDOWN_IMMEDIATE = 0;  // 立即执行
```

---

## 二、各指令详细逻辑

### 2.1 离间（ALIENATE）

**功能说明**：挑拨敌方武将与其君主的关系，降低其忠诚度。

**执行流程**：
1. 选择执行武将（高智力优先）
2. 选择目标城市（必须是敌方城市）
3. 选择目标武将
4. 计算成功率
5. 执行离间
6. 显示结果

**成功率计算**：
```typescript
function calculateAlienateRate(
  executor: PersonType,
  target: PersonType
): number {
  // 基础成功率 = 执行者IQ - 目标IQ + 50
  let baseRate = executor.iq - target.iq + 50;
  
  // 不能超过100%
  if (baseRate > 100) baseRate = 100;
  
  // 随机判定是否通过智力差
  let roll1 = Math.random() * 100;
  if (roll1 > baseRate) {
    return 0; // 第一步失败
  }
  
  // 忠诚度判定（忠诚度越低越容易被离间）
  let roll2 = Math.random() * 100;
  if (roll2 < target.devotion) {
    return 0; // 忠诚度太高，无法离间
  }
  
  // 根据性格计算最终成功率
  let characterRate = 0;
  switch (target.character) {
    case CHARACTER_LOYALISM:  // 忠义
      characterRate = 5;
      break;
    case CHARACTER_IDEAL:     // 大志
      characterRate = 30;
      break;
    case CHARACTER_AVARICE:   // 贪财
      characterRate = 40;
      break;
    case CHARACTER_DREAD:     // 怕死
      characterRate = 30;
      break;
    case CHARACTER_TEMERITY:  // 卤莽
      characterRate = 50;
      break;
  }
  
  // 最终判定
  let roll3 = Math.random() * 100;
  if (roll3 > characterRate) {
    return 0; // 性格抵抗成功
  }
  
  return 1; // 离间成功
}
```

**离间效果**：
```typescript
function executeAlienate(
  executor: PersonType,
  target: PersonType
): AlienateResult {
  if (calculateAlienateRate(executor, target) > 0) {
    // 成功：降低忠诚度
    let oldDevotion = target.devotion;
    target.devotion = Math.max(0, target.devotion - 4);
    
    // 根据忠诚度区间选择台词
    let devotionLevel = getDevotionLevel(target.devotion);
    let successDialogs = [
      "主多疑而不用，吾当如何处之！",      // >80
      "赏罚不明，何以服众！",              // >60
      "优柔寡断，非明主之像！",            // >40
      "鼠目寸光，岂为明主邪！"             // <=40
    ];
    
    return {
      success: true,
      devotionDecrease: oldDevotion - target.devotion,
      currentDevotion: target.devotion,
      targetDialog: successDialogs[devotionLevel],
      executorDialog: getRandomDialog('alienate_success')
    };
  } else {
    // 失败：显示抵抗台词
    let devotionLevel = getDevotionLevel(target.devotion);
    let failDialogs = [
      "天选之子，吾誓死守护！",            // >80
      "鼠辈安敢行此卑鄙之事!",             // >60
      "疏不间亲，阁下自重！"               // <=60
    ];
    
    return {
      success: false,
      targetDialog: failDialogs[Math.min(devotionLevel, 2)]
    };
  }
}

function getDevotionLevel(devotion: number): number {
  if (devotion > 80) return 0;
  if (devotion > 60) return 1;
  if (devotion > 40) return 2;
  return 3;
}
```

**执行者台词**（离间成功时随机）：
- "凭我的三寸不烂之舌，定让他回心转意。"

---

### 2.2 招揽（CANVASS）

**功能说明**：尝试招募其他势力的武将加入我方。

**执行流程**：
1. 选择执行武将
2. 选择目标城市
3. 选择目标武将（必须不是君主）
4. 计算成功率
5. 执行招揽
6. 显示结果

**成功率计算**：
```typescript
function calculateCanvassRate(
  executor: PersonType,
  target: PersonType
): number {
  // 基础成功率差 = 执行者IQ - 目标IQ
  let iqDiff = executor.iq - target.iq;
  
  // 随机判定智力差
  let roll1 = Math.random() * 100;
  if ((roll1 + 100) > (iqDiff + 100)) {
    return 0; // 智力差判定失败
  }
  
  // 忠诚度判定
  let roll2 = Math.random() * 100;
  if (roll2 < target.devotion) {
    return 0; // 忠诚度太高
  }
  
  // 性格系数
  let characterRate = 0;
  switch (target.character) {
    case CHARACTER_LOYALISM:  // 忠义
      characterRate = 5;
      break;
    case CHARACTER_IDEAL:     // 大志
      characterRate = 20;
      break;
    case CHARACTER_AVARICE:   // 贪财
      characterRate = 30;
      break;
    case CHARACTER_DREAD:     // 怕死
      characterRate = 40;
      break;
    case CHARACTER_TEMERITY:  // 卤莽
      characterRate = 15;
      break;
  }
  
  // 最终判定
  let roll3 = Math.random() * 100;
  if (roll3 > characterRate) {
    return 0;
  }
  
  return 1;
}
```

**执行逻辑**：
```typescript
function executeCanvass(
  executor: PersonType,
  target: PersonType,
  targetCity: CityType,
  executorCity: CityType
): CanvassResult {
  // 检查目标所在城市
  let currentCity = getPersonCity(target.id);
  if (currentCity === 0xFF) {
    return { success: false, reason: '不在城中' };
  }
  
  if (calculateCanvassRate(executor, target) > 0) {
    // 成功招揽
    // 1. 从原城市移除
    delPerson(currentCity, target.id);
    
    // 2. 添加到执行者城市
    addPerson(executorCity.id, target.id);
    
    // 3. 改变归属
    target.belong = executor.belong;
    target.devotion = 40 + Math.random() * 40;
    
    // 4. 成功台词
    let successDialogs = [
      "良禽择木而栖，贤臣择主而仕",
      "伏处一方，唯待明主，其在君乎?",
      "闻君贤名久矣，愿为君牵马坠镫！",
      "固所愿也，不敢请尔!",
      "赴汤蹈火，在所不辞！"
    ];
    
    return {
      success: true,
      targetDialog: randomSelect(successDialogs),
      newDevotion: target.devotion
    };
  } else {
    // 失败台词
    let failDialogs = [
      "燕雀安知鸿鹄之志哉!",
      "无能之辈，焉敢如此！",
      "忠臣不仕二主！"
    ];
    
    return {
      success: false,
      targetDialog: randomSelect(failDialogs)
    };
  }
}
```

---

### 2.3 策反（COUNTERESPIONAGE）

**功能说明**：策反敌方太守，使其脱离原势力自立为王。

**执行流程**：
1. 选择执行武将
2. 选择目标城市
3. 确认目标（必须是敌方太守）
4. 计算成功率
5. 执行策反
6. 显示结果

**成功率计算**：
```typescript
function calculateCounterespionageRate(
  executor: PersonType,
  target: PersonType
): number {
  // 基础成功率 = 执行者IQ - 目标IQ + 50
  let baseRate = executor.iq - target.iq + 50;
  
  // 不能超过100
  if (baseRate > 100) baseRate = 100;
  
  // 智力判定
  let roll1 = Math.random() * 100;
  if (roll1 > baseRate) {
    return 0;
  }
  
  // 忠诚度判定
  let roll2 = Math.random() * 100;
  if (roll2 < target.devotion) {
    return 0;
  }
  
  // 性格系数
  let characterRate = 0;
  switch (target.character) {
    case CHARACTER_LOYALISM:  // 忠义
      characterRate = 5;
      break;
    case CHARACTER_IDEAL:     // 大志 - 最容易被策反
      characterRate = 60;
      break;
    case CHARACTER_AVARICE:   // 贪财
      characterRate = 20;
      break;
    case CHARACTER_DREAD:     // 怕死
      characterRate = 10;
      break;
    case CHARACTER_TEMERITY:  // 卤莽
      characterRate = 30;
      break;
  }
  
  // 最终判定
  let roll3 = Math.random() * 100;
  if (roll3 > characterRate) {
    return 0;
  }
  
  return 1;
}
```

**执行逻辑**：
```typescript
function executeCounterespionage(
  executor: PersonType,
  target: PersonType,
  targetCity: CityType
): CounterespionageResult {
  // 检查目标是否为太守
  if (targetCity.satrapId !== target.id + 1) {
    return { success: false, reason: '目标不是太守' };
  }
  
  if (calculateCounterespionageRate(executor, target) > 0) {
    // 策反成功
    
    // 1. 获取城中所有武将
    let cityPersons = getCityPersons(targetCity.id);
    
    // 2. 目标自立为新君主
    target.belong = target.id + 1;
    target.devotion = 100; // 自己对自己忠诚
    
    // 3. 城市归属改变
    targetCity.belong = target.id + 1;
    
    // 4. 城中所有武将归属改变
    for (let personId of cityPersons) {
      g_persons[personId].belong = target.id + 1;
    }
    
    // 5. 成功台词
    let successDialogs = [
      "王侯将相，宁有种乎！",
      "揭竿而起，为民请命！",
      "积粮聚兵，逐鹿天下！"
    ];
    
    return {
      success: true,
      newKing: target.id,
      targetDialog: randomSelect(successDialogs),
      message: `${getPersonName(target.id)} 被策反成为君主`
    };
  } else {
    // 失败台词
    let failDialogs = [
      "君臣相得，岂屑小所可趁也！",
      "赤胆忠心，誓佐明主定天下！"
    ];
    
    return {
      success: false,
      targetDialog: randomSelect(failDialogs)
    };
  }
}
```

**策反成功效果**：
- 目标武将变为新君主
- 该城市成为新势力
- 城中所有武将转入新势力

---

### 2.4 劝降（INDUCE）

**功能说明**：劝说敌方君主带领所有城市归降。

**执行流程**：
1. 选择执行武将
2. 选择目标君主
3. 检查条件
4. 计算成功率
5. 执行劝降
6. 显示结果

**前提条件**：
```typescript
function checkInduceCondition(
  executor: PersonType,
  targetKing: PersonType
): boolean {
  // 不能劝降玩家
  if (targetKing.id === g_playerKing) {
    return false;
  }
  
  // 我方城池数量必须是对方的至少2倍
  let myCities = getKingCitys(executor.belong - 1).length;
  let targetCities = getKingCitys(targetKing.id).length;
  
  if (myCities < targetCities * 2) {
    return false;
  }
  
  return true;
}
```

**成功率计算**：
```typescript
function calculateInduceRate(
  executor: PersonType,
  targetKing: PersonType
): number {
  // 检查基本条件
  if (!checkInduceCondition(executor, targetKing)) {
    return 0;
  }
  
  // 基础成功率 = 执行者IQ - 目标IQ + 50
  let baseRate = executor.iq - targetKing.iq + 50;
  
  // 智力判定
  let roll1 = Math.random() * 100;
  if (roll1 > baseRate) {
    return 0;
  }
  
  // 根据君主性格
  let characterRate = 0;
  switch (targetKing.character) {
    case CHARACTER_PEACE:      // 和平
      characterRate = 15;
      break;
    case CHARACTER_JUSTICE:    // 大义
      characterRate = 5;
      break;
    case CHARACTER_DUPLICITY:  // 奸诈
      characterRate = 20;
      break;
    case CHARACTER_CRAZY:      // 狂人
      characterRate = 1;
      break;
    case CHARACTER_RASH:       // 冒进
      characterRate = 10;
      break;
  }
  
  // 最终判定
  let roll2 = Math.random() * 100;
  if (roll2 > characterRate) {
    return 0;
  }
  
  return 1;
}
```

**执行逻辑**：
```typescript
function executeInduce(
  executor: PersonType,
  targetKing: PersonType
): InduceResult {
  if (calculateInduceRate(executor, targetKing) > 0) {
    // 劝降成功
    
    // 1. 获取目标所有城市
    let targetCities = getKingCitys(targetKing.id);
    
    // 2. 改变所有城市归属
    for (let cityId of targetCities) {
      g_cities[cityId].belong = executor.belong;
      
      // 城中武将归属改变
      let cityPersons = getCityPersons(cityId);
      for (let personId of cityPersons) {
        g_persons[personId].belong = executor.belong;
      }
    }
    
    // 3. 处理不在城中的人员
    for (let i = 0; i < PERSON_COUNT; i++) {
      if (g_persons[i].belong === targetKing.id + 1) {
        if (i === targetKing.id) {
          // 君主本人归降
          g_persons[i].belong = executor.belong;
        } else {
          // 其他人员变为在野
          g_persons[i].belong = 0;
        }
      }
    }
    
    // 4. 成功台词
    let successDialogs = [
      "事到如今，也只好降了……",
      "此乃天命，请明公善待我的部属和百姓。",
      "为了避免生灵涂炭，降也是无可奈何……",
      "我乃竭诚投降，请明公勿疑！"
    ];
    
    return {
      success: true,
      citiesCount: targetCities.length,
      targetDialog: randomSelect(successDialogs),
      message: `${getPersonName(targetKing.id)} 势力归降 ${getPersonName(executor.belong - 1)}`
    };
  } else {
    // 失败台词
    let failDialogs = [
      "此事不必再说，战场上分高低！",
      "你快回去备好兵马，我到战场上再答复你。",
      "笑话，该投降的是你们吧！",
      "大胆！竟敢小看我，滚回去喜好脖子！"
    ];
    
    return {
      success: false,
      targetDialog: randomSelect(failDialogs)
    };
  }
}
```

---

## 三、外交指令通用机制

### 3.1 目标选择限制

所有外交指令对目标的选择都有以下限制：

1. **城市必须是敌方势力**
   - 不能对自己的城市执行外交指令
   - 目标城市必须有武将

2. **武将体力要求**
   - 执行外交指令需要4点体力
   - 体力不足无法执行

3. **冷却时间**
   - 外交指令立即执行，无冷却
   - 但武将在执行期间视为"外出"状态

### 3.2 成功率综合因素

外交指令的成功率由以下因素共同决定：

```
成功率 = f(智力差, 忠诚度, 性格系数, 随机因素)
```

**影响因素权重**：
- 智力差（执行者IQ - 目标IQ）：基础权重
- 目标忠诚度：忠诚度越高越难成功
- 目标性格：不同性格有不同抵抗力
- 随机因素：增加不确定性

### 3.3 对话系统

外交指令执行时会触发对话，分为：

1. **执行者台词**：显示执行武将的决心
2. **目标台词**：根据成功/失败显示不同反应

对话内容根据：
- 忠诚度区间
- 性格类型
- 成功/失败结果

动态选择显示。

---

## 四、交互流程设计

### 4.1 外交指令选择流程

```
选择城市 → 外交指令菜单 → 选择具体指令 → 选择执行武将 → 选择目标城市 → 选择目标武将 → 确认执行 → 显示结果
```

### 4.2 界面布局

**外交菜单**：
```
┌─────────────────────┐
│     外 交 指 令      │
├─────────────────────┤
│  1. 离间            │
│  2. 招揽            │
│  3. 策反            │
│  4. 劝降            │
├─────────────────────┤
│     [取消] [确定]    │
└─────────────────────┘
```

**目标选择界面**：
```
┌─────────────────────┐
│  请选择目标武将      │
├─────────────────────┤
│  赵云    忠诚度:85  │
│  张飞    忠诚度:95  │
│  关羽    忠诚度:100 │
│  马超    忠诚度:70  │
├─────────────────────┤
│  成功率预估: 中等   │
└─────────────────────┘
```

### 4.3 结果展示

**成功时**：
- 显示成功提示
- 显示双方对话
- 显示数值变化

**失败时**：
- 显示失败提示
- 显示目标拒绝台词
- 无数值变化

---

## 五、AI外交行为

### 5.1 AI执行外交指令逻辑

AI势力每月也会执行外交指令：

```typescript
function aiDiplomacyDecision(king: PersonType): void {
  // 1. 获取可用武将
  let availablePersons = getAvailablePersons(king.id);
  
  // 2. 获取可执行目标
  let targetCities = getEnemyCities(king.id);
  
  // 3. 根据优先级选择指令
  let priorities = ['离间', '招揽', '策反'];
  
  for (let person of availablePersons) {
    let action = randomSelectWithPriority(priorities);
    let target = selectBestTarget(person, action, targetCities);
    
    if (target) {
      executeDiplomaticAction(person, action, target);
    }
  }
}
```

### 5.2 AI目标选择策略

**离间**：优先选择高能力、中等忠诚度的武将
**招揽**：优先选择低忠诚度的武将
**策反**：优先选择太守且忠诚度较低的城市

---

*文档版本：1.0*  
*创建日期：2026-02-10*
