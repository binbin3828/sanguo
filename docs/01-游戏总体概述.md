# 三国霸业 - 游戏功能设计文档

## 文档说明

本文档是对原版C++像素风格《三国霸业》战旗游戏的详细功能拆解，用于指导使用HTML+JS技术栈进行现代化重构开发。保留原游戏所有玩法逻辑、数值系统和算法，仅将UI从像素风格升级为现代界面。

---

## 一、游戏总体概述

### 1.1 游戏类型
- **核心类型**：回合制策略战旗游戏（SLG）
- **游戏视角**：2D俯视视角
- **操作方式**：鼠标/触控操作（支持键盘快捷键）

### 1.2 游戏背景
以三国时期为历史背景，玩家扮演一方君主，通过内政管理、外交策略和军事征战统一全国。

### 1.3 核心玩法循环

```
开始菜单 → 选择剧本/君主 → 战略回合 → 战斗（可选） → 结算 → 下一回合
                ↓
          内政/外交/军事指令
                ↓
          执行指令 → 下一月
```

### 1.4 游戏主要模块

1. **主菜单系统**：新游戏、读档、制作群、退出
2. **剧本选择**：4个历史时期可选
3. **君主选择**：每个时期对应不同可选君主
4. **战略地图**：城市分布、势力范围可视化
5. **城市指令系统**：内政、外交、军事三大类别
6. **战斗系统**：战旗式回合制战斗
7. **档案系统**：存档/读档功能

---

## 二、游戏核心数据结构

### 2.1 武将数据（PersonType）

```typescript
interface PersonType {
  oldBelong: number;      // 原归属（编号）
  belong: number;         // 当前归属（势力ID）
  level: number;          // 等级 (1-20)
  force: number;          // 武力 (影响攻击)
  iq: number;             // 智力 (影响防御、计谋成功率)
  devotion: number;       // 忠诚度 (0-100)
  character: number;      // 性格类型 (0-4)
  experience: number;     // 经验值 (0-99，满100升级)
  thew: number;           // 体力 (影响战斗HP和MP)
  armsType: number;       // 兵种类型 (0-5)
  arms: number;           // 兵力数量
  equip: [number, number]; // 装备道具 [道具1, 道具2]
  age: number;            // 年龄
}
```

**关键数值说明**：
- 最大武将数：2000人
- 武将寿命：90岁
- 武将出现年龄：16岁
- 最大等级：20级（可通过配置调整）

### 2.2 城市数据（CityType）

```typescript
interface CityType {
  state: number;              // 城市状态 (0-4)
  belong: number;             // 归属势力
  satrapId: number;           // 太守编号
  farmingLimit: number;       // 农业开发上限
  farming: number;            // 当前农业开发度
  commerceLimit: number;      // 商业开发上限
  commerce: number;           // 当前商业开发度
  peopleDevotion: number;     // 民忠 (0-100)
  avoidCalamity: number;      // 防灾值
  populationLimit: number;    // 人口上限
  population: number;         // 当前人口
  money: number;              // 金钱
  food: number;               // 粮食
  mothballArms: number;       // 后备兵力
  personQueue: number;        // 人才队列（索引）
  persons: number;            // 城中武将数
  toolQueue: number;          // 道具队列（索引）
  tools: number;              // 城中道具数
}
```

**城市状态定义**：
- 0: 正常
- 1: 饥荒
- 2: 旱灾
- 3: 水灾
- 4: 暴动

### 2.3 道具数据（Goods/Tool）

```typescript
interface Goods {
  idx: number;                // 道具序号
  useFlag: number;            // 使用标志 (装备/使用)
  atRange: number[];          // 攻击范围数据 [30]
  changeAttackRange: boolean; // 是否改变攻击范围
  at: number;                 // 武力加成
  iq: number;                 // 智力加成
  move: number;               // 移动力加成
  arm: number;                // 兵种改变
}
```

### 2.4 命令数据结构（OrderType）

```typescript
interface OrderType {
  orderId: number;    // 命令编号
  person: number;     // 执行武将
  city: number;       // 所在城市
  object: number;     // 目标对象
  arms: number;       // 士兵数量
  food: number;       // 粮食数量
  money: number;      // 金钱数量
  consume: number;    // 消耗时间
  timeCount: number;  // 执行累时
}
```

### 2.5 战斗相关数据结构

#### 2.5.1 战斗接口（FGTJK）

```typescript
interface FGTJK {
  mode: number;           // 战斗模式 (0防御/1进攻)
  way: number;            // 进攻方向 (0-7)
  mapId: number;          // 战斗地图ID
  mProvender: number;     // 玩家粮草
  eProvender: number;     // 敌人粮草
  genArray: number[];     // 将领队列 [20]
  cityIndex: number;      // 战斗城市ID
}
```

#### 2.5.2 战斗将领位置（JLPOS）

```typescript
interface JLPOS {
  x: number;              // 地图坐标X
  y: number;              // 地图坐标Y
  hp: number;             // 生命值
  mp: number;             // 技能点
  move: number;           // 移动力
  active: number;         // 激活状态 (0等待/1结束)
  state: number;          // 状态 (0-8)
}
```

#### 2.5.3 战斗属性（JLATT）

```typescript
interface JLATT {
  level: number;          // 等级指针
  canny: number;          // 中计谋可能性
  ter: number;            // 所在地形
  bile: number;           // 愤怒值
  armsType: number;       // 兵种
  exp: number;            // 经验指针
  arms: number;           // 兵力指针
  at: number;             // 攻击力
  df: number;             // 防御力
  generalIndex: number;   // 将领战场序号
}
```

#### 2.5.4 战斗命令（FGTCMD）

```typescript
interface FGTCMD {
  type: number;           // 命令类型 (0攻击/1计谋/2查看/3休息)
  param: number;          // 命令参数
  sIdx: number;           // 执行者脚标
  aIdx: number;           // 承受者脚标
}
```

#### 2.5.5 技能效果（SKILLEF）

```typescript
interface SKILLEF {
  aim: number;            // 施展目标 (0敌方/1我方)
  state: number;          // 对目标状态的影响
  power: number;          // 对兵力的基本伤害
  destroy: number;        // 对粮草的基本伤害
  useMp: number;          // 消耗技能点
  weather: number[];      // 天气效果 [5]
  eland: number[];        // 敌人地形效果 [8]
  oland: number[];        // 我方地形效果 [8]
  earm: number[];         // 敌人兵种加成 [6]
}
```

#### 2.5.6 技能定义（SKILL）

```typescript
interface SKILL {
  name: string;           // 技能名称 (4字节)
  inf: string;            // 技能说明 (50字节)
  ef: SKILLEF;            // 技能效果
  range: number[];        // 攻击范围 [81] (9x9)
}
```

### 2.6 全局状态数据

```typescript
interface GameState {
  // 基础状态
  playerKing: number;         // 玩家扮演君主ID
  yearDate: number;           // 年份
  monthDate: number;          // 月份 (1-12)
  cityPos: CitySetType;       // 地图显示位置
  
  // 游戏设置
  lookEnemy: boolean;         // 观看敌人行动
  lookMovie: boolean;         // 观看动画
  moveSpeed: boolean;         // 移动速度
  
  // 武将数据
  persons: PersonType[];      // 所有武将 [2000]
  personsQueue: number[];     // 武将队列 [2000]
  
  // 城市数据
  cities: CityType[];         // 所有城市 [38]
  
  // 道具数据
  goodsQueue: number[];       // 道具队列 [2000]
  
  // 战斗数据
  fightersIdx: number[];      // 战斗将领索引 [30]
  fighters: Fighter[];        // 战斗数据 [30]
  orderQueue: OrderType[];    // 命令队列 [200]
  
  // 战斗运行时数据
  fightMap: number[];         // 战斗地图数据
  fightMapData: number[];     // 地图原始数据
  fightPath: number[];        // 行军路径
  fgtAtkRng: number[];        // 攻击范围
  genPos: JLPOS[];            // 将领位置 [20]
  genAtt: JLATT[];            // 战斗属性 [2]
  fgtParam: FGTJK;            // 战斗参数
  fgtOver: number;            // 战斗结束标志
  fgtBoutCnt: number;         // 战斗回合数
  fgtWeather: number;         // 天气
}
```

---

## 三、关键常量定义

### 3.1 兵种定义

| 编号 | 兵种 | 移动力 | 攻击系数 | 防御系数 |
|------|------|--------|----------|----------|
| 0 | 骑兵 | 5 | 1.0 | 0.7 |
| 1 | 步兵 | 4 | 1.2 | 1.2 |
| 2 | 弓箭兵 | 4 | 0.9 | 1.0 |
| 3 | 水军 | 5 | 0.8 | 1.1 |
| 4 | 极兵 | 6 | 1.3 | 1.2 |
| 5 | 玄兵 | 3 | 0.4 | 0.6 |

### 3.2 地形定义

| 编号 | 地形 | 说明 |
|------|------|------|
| 0 | 草地 | 基础地形 |
| 1 | 平原 | 移动力消耗低 |
| 2 | 山地 | 防御加成 |
| 3 | 森林 | 防御加成 |
| 4 | 村庄 | 恢复效果 |
| 5 | 城池 | 最高防御 |
| 6 | 营寨 | 防御加成 |
| 7 | 河流 | 特殊地形 |

### 3.3 战斗状态定义

| 编号 | 状态 | 效果 |
|------|------|------|
| 0 | 正常 | 无异常 |
| 1 | 混乱 | 随机移动 |
| 2 | 禁咒 | 无法使用计谋 |
| 3 | 定身 | 移动力=1 |
| 4 | 奇门 | 可穿过敌方 |
| 5 | 遁甲 | 免疫某些攻击 |
| 6 | 石阵 | 每回合损失兵力 |
| 7 | 潜踪 | 隐身效果 |
| 8 | 死亡 | 武将阵亡 |

### 3.4 性格类型定义

**武将性格**（影响招降/离间成功率）：

| 编号 | 性格 | 离间系数 | 招揽系数 | 策反系数 | 招降系数 |
|------|------|----------|----------|----------|----------|
| 0 | 卤莽 | 50 | 15 | 30 | 15 |
| 1 | 怕死 | 30 | 40 | 10 | 60 |
| 2 | 贪财 | 40 | 30 | 20 | 30 |
| 3 | 大志 | 30 | 20 | 60 | 20 |
| 4 | 忠义 | 5 | 5 | 5 | 5 |

**君主性格**（影响劝降成功率）：

| 编号 | 性格 | 劝降系数 |
|------|------|----------|
| 0 | 冒进 | 10 |
| 1 | 狂人 | 1 |
| 2 | 奸诈 | 20 |
| 3 | 大义 | 5 |
| 4 | 和平 | 15 |

---

## 四、引擎配置参数

```typescript
interface EngineConfig {
  // 兵种相克矩阵 [6][6]
  subduModu: number[][];
  
  // 攻击/防御系数
  atkModulus: number[];      // 各兵种攻击系数 [6]
  dfModulus: number[];       // 各兵种防御系数 [6]
  terrDfModu: number[];      // 地形防御系数 [8]
  
  // 数值计算比例
  armsPerMoney: number;           // 每金钱可买兵数 (默认10)
  armsPerDevotion: number;        // 征兵量与民忠关系 (默认20)
  maxLevel: number;               // 最大等级 (默认20)
  
  // 自定义计算公式开关和参数
  enableCustomRatio: boolean;
  ratioOfArmsToLevel: number;     // 带兵量与等级关系 (默认100)
  ratioOfArmsToAge: number;       // 带兵量与年龄关系 (默认0)
  ratioOfArmsToIQ: number;        // 带兵量与智力关系 (默认10)
  ratioOfArmsToForce: number;     // 带兵量与武力关系 (默认10)
  ratioOfAttToForce: number;      // 攻击与武力关系 (默认10)
  ratioOfAttToIQ: number;         // 攻击与智力关系 (默认0)
  ratioOfAttToAge: number;        // 攻击与年龄关系 (默认0)
  ratioOfDefenceToIQ: number;     // 防御与智力关系 (默认10)
  ratioOfDefenceToForce: number;  // 防御与武力关系 (默认0)
  ratioOfDefenceToAge: number;    // 防御与年龄关系 (默认0)
  
  // 粮草消耗
  ratioOfFoodToArmsPerMouth: number;  // 市政粮草消耗 (默认50)
  ratioOfFoodToArmsPerDay: number;    // 战场粮草消耗 (默认3)
  
  // AI配置
  aiLevelUpSpeed: number;         // AI升级速度
  aiDefenceMode: number;          // AI行军策略 (0追主将/1守城)
  aiAttackMethod: number;         // AI攻击算法 (0原版/1优化)
  
  // 功能开关
  enableScript: boolean;          // 启用脚本
  disableExpGrowing: boolean;     // 禁用经验增长
  disableAgeGrow: boolean;        // 禁用年龄增长
  disableSL: boolean;             // 禁用存读档
}
```

---

## 五、文档结构说明

本文档为系列文档的第一部分，包含游戏的整体架构和核心数据结构定义。后续文档将详细描述：

1. **内政系统**：开垦、招商、搜寻、治理等指令的详细逻辑
2. **外交系统**：离间、招揽、策反、劝降等指令的详细逻辑
3. **军事系统**：征兵、出征、战斗等指令的详细逻辑
4. **战斗系统**：战斗流程、移动算法、攻击计算、AI行为等
5. **数值系统**：所有计算公式、概率算法、升级系统等

---

## 六、技术重构建议

### 6.1 前端技术栈
- **框架**：原生JavaScript / Vue 3 / React
- **渲染**：Canvas API / WebGL (推荐PixiJS或Phaser)
- **状态管理**：Redux / Pinia / 自定义状态管理
- **资源加载**：自定义资源管理器

### 6.2 数据管理
- 使用JSON格式存储游戏配置数据
- 使用LocalStorage或IndexedDB实现存档功能
- 考虑使用TypeScript进行类型安全开发

### 6.3 渲染架构
- 地图层：背景地图、地形显示
- 单位层：城市、武将、军队
- UI层：菜单、信息面板、对话框
- 特效层：动画、粒子效果

### 6.4 保留的核心算法
- 行军路径计算算法（FgtCountPath）
- 战斗伤害计算算法（CountAtkHurt）
- 成功率计算算法（各类外交指令）
- 经验升级系统

---

*文档版本：1.0*  
*创建日期：2026-02-10*  
*基于：三国霸业C++源代码分析*
