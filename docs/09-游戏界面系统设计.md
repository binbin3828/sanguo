# 游戏界面系统详细设计

## 文档概述

本文档详细描述《三国霸业-重置版》的UI界面系统，包括剧本选择界面、君主选择界面的设计规范、功能实现和技术细节。

---

## 一、界面架构

### 1.1 界面层级结构

```
游戏界面层级
├── 主菜单 (MainMenuScreen)
├── 剧本选择 (PeriodSelectScreen)
├── 君主选择 (KingSelectScreen)
├── 战略地图 (StrategyMapScreen)
├── 城市界面 (CityScreen)
├── 战斗界面 (BattleScreen)
└── 存档界面 (SaveLoadScreen)
```

### 1.2 界面切换流程

```
游戏启动
    ↓
主菜单 → [新游戏] → 剧本选择 → 君主选择 → 战略地图
    ↓                    ↓
 [读档]             [返回] → 剧本选择
    ↓
存档界面
```

---

## 二、剧本选择界面 (PeriodSelectScreen)

### 2.1 界面定位

- **文件路径**: `src/ui/screens/PeriodSelectScreen.js`
- **界面职责**: 让玩家选择游戏开始的历史时期(剧本)
- **入口**: 主菜单点击"新游戏"
- **出口**: 选中剧本后进入君主选择界面

### 2.2 时期配置

游戏提供4个历史时期供选择:

| 时期ID | 名称 | 年份 | 描述 | 主题色 | 强调色 |
|--------|------|------|------|--------|--------|
| 1 | 董卓弄权 | 190年 | 汉末乱世初期 | #8b0000 | #ff4500 |
| 2 | 曹操崛起 | 198年 | 中原争霸 | #1a472a | #228b22 |
| 3 | 赤壁之战 | 208年 | 三国鼎立前夕 | #1a3a5c | #4169e1 |
| 4 | 三国鼎立 | 225年 | 魏蜀吴三国形成 | #4a3a1a | #ffd700 |

### 2.3 视觉设计

#### 2.3.1 布局结构

```
┌─────────────────────────────────────────────────────────────┐
│  ← 返回主菜单                                            v1.0 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    选择历史剧本                              │
│                                                             │
├───────────────┬─────────────────────────────────────────────┤
│               │                                             │
│ ┌───────────┐ │  ┌───────────┐                              │
│ │ 董卓弄权  │ │  │ 曹操崛起  │                              │
│ │   190年   │ │  │   198年   │                              │
│ │ 汉末乱世  │ │  │ 中原争霸  │                              │
│ └───────────┘ │  └───────────┘                              │
│               │                                             │
│ ┌───────────┐ │  ┌───────────┐                              │
│ │ 赤壁之战  │ │  │ 三国鼎立  │                              │
│ │   208年   │ │  │   225年   │                              │
│ │ 鼎立前夕  │ │  │ 三国形成  │                              │
│ └───────────┘ │  └───────────┘                              │
│               │                                             │
└───────────────┴─────────────────────────────────────────────┘
```

#### 2.3.2 卡片设计

每个时期以卡片形式展示:

**卡片规格**:
- 宽度: 320px
- 高度: 180px
- 圆角: 12px
- 间距: 横向40px, 纵向35px

**视觉元素**:
1. **背景**: 根据时期加载对应的SVG背景图
2. **装饰图案**: 每个时期独特的矢量图标
   - 时期1: 火焰图案(董卓暴政)
   - 时期2: 旗帜图案(曹操起兵)
   - 时期3: 战船图案(赤壁水战)
   - 时期4: 三柱鼎立图案(三国格局)
3. **文字**: 
   - 时期名称(大字居中)
   - 年份(小字)
   - 描述(小字)

**交互效果**:
- **悬停**: 
  - 卡片放大1.05倍
  - 金色边框发光
  - 阴影增强
- **选中**: 
  - 边框加粗
  - 持续发光效果
  - 背景图显示

#### 2.3.3 背景设计

- **基础背景**: 深蓝渐变(0a0a1a → 080812)
- **网格纹理**: 0.02透明度点阵网格
- **装饰线条**: 金色水平线(上下各一条)
- **粒子效果**: 20个金色漂浮粒子

### 2.4 技术实现

#### 2.4.1 核心类结构

```javascript
export class PeriodSelectScreen {
    constructor(engine) {
        this.engine = engine;
        this.eventBus = engine.eventBus;
        this.selectedPeriod = 1;        // 当前选中时期ID
        this.periods = [...];           // 时期数据数组
        this.cards = [];                // 卡片对象数组
        this.animationTime = 0;         // 动画时间累计
        this.particles = [];            // 粒子数组
        this.backgroundImages = {};     // 背景图片缓存
    }
    
    // 初始化方法
    _initParticles()      // 初始化20个粒子
    _initCards()          // 初始化4个卡片位置
    _initBackgroundImages() // 异步加载背景图
    
    // 生命周期
    onEnter()             // 进入界面时调用
    onSelectPeriod(id)    // 选择时期
    onBack()              // 返回主菜单
    
    // 更新与渲染
    update(deltaTime)     // 每帧更新
    render(ctx)           // 渲染界面
}
```

#### 2.4.2 卡片数据结构

```javascript
{
    id: 1,                    // 时期ID
    x: 100,                   // 屏幕X坐标
    y: 200,                   // 屏幕Y坐标
    width: 320,               // 卡片宽度
    height: 180,              // 卡片高度
    period: {...},            // 时期数据引用
    hoverProgress: 0.0,       // 悬停动画进度(0-1)
    isHovered: false,         // 是否悬停
    selectProgress: 0.0       // 选中动画进度(0-1)
}
```

#### 2.4.3 粒子系统

```javascript
{
    x: 512,                   // 当前X坐标
    y: 384,                   // 当前Y坐标
    size: 2.5,                // 粒子大小(1-3)
    speedX: 0.1,              // X方向速度(-0.1~0.1)
    speedY: -0.05,            // Y方向速度(-0.1~0.1)
    opacity: 0.3              // 透明度(0.1-0.5)
}
```

**粒子行为**:
- 匀速直线运动
- 边界环绕(出界后从对侧进入)
- 固定数量(20个)

#### 2.4.4 渲染流程

```javascript
render(ctx) {
    _renderBackground(ctx, w, h)    // 1. 绘制背景
    _renderParticles(ctx)           // 2. 绘制粒子
    _renderTitle(ctx, w)            // 3. 绘制标题
    _renderCards(ctx)               // 4. 绘制4个卡片
    _renderBackButton(ctx, w, h)    // 5. 绘制返回按钮
    _renderVersion(ctx, w, h)       // 6. 绘制版本号
}
```

#### 2.4.5 事件系统

**触发事件**:
- `period.selected`: 选择时期时触发
  - 参数: periodId, periodName
- `screen.change`: 切换界面
  - 参数: 'KingSelect' 或 'MainMenu'

### 2.5 交互设计

#### 2.5.1 鼠标操作

| 操作 | 响应 |
|------|------|
| 移动 | 检测悬停在哪个卡片上,设置isHovered |
| 点击卡片 | 触发onSelectPeriod,切换界面 |
| 点击返回 | 触发onBack,返回主菜单 |

#### 2.5.2 动画效果

| 动画 | 触发条件 | 持续时间 | 缓动函数 |
|------|----------|----------|----------|
| 悬停放大 | mouseenter | 166ms | linear |
| 悬停缩小 | mouseleave | 166ms | linear |
| 选中边框 | click | 100ms | linear |
| 粒子移动 | 持续 | - | linear |
| 标题发光 | 持续 | 3000ms | sin wave |

---

## 三、君主选择界面 (KingSelectScreen)

### 3.1 界面定位

- **文件路径**: `src/ui/screens/KingSelectScreen.js`
- **界面职责**: 让玩家选择扮演的君主,查看势力分布
- **入口**: 剧本选择界面选中剧本后
- **出口**: 确认选择后进入战略地图

### 3.2 布局结构

```
┌─────────────────────────────────────────────────────────────┐
│  ← 返回                                                v1.0 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                      选择君主                               │
│                                                             │
├──────────────────┬──────────────────────────────────────────┤
│ 可选君主          │                                          │
│ <当前剧本名称>    │           战略地图                        │
│                   │                                          │
│ ┌───────────────┐ │  ┌────────────────────────────────────┐  │
│ │ 曹操      ✓   │ │  │                                    │  │
│ ├───────────────┤ │  │    ●许昌      ●邺城                │  │
│ │ 刘备          │ │  │        ●陈留                       │  │
│ ├───────────────┤ │  │           ●洛阳                    │  │
│ │ 孙权          │ │  │              ●长安                 │  │
│ ├───────────────┤ │  │    ●成都              ●建业        │  │
│ │ 袁绍          │ │  │         ●襄阳                      │  │
│ ├───────────────┤ │  │                   ●寿春            │  │
│ │ ...           │ │  │                        ●下邳       │  │
│ └───────────────┘ │  │                                    │  │
│      ━━━━━━       │  └────────────────────────────────────┘  │
│                   │                                          │
└──────────────────┴──────────────────────────────────────────┤
│                                                    开始游戏 → │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 功能分区

#### 3.3.1 左侧君主列表

**列表规格**:
- 位置: X=80, Y=140
- 尺寸: 宽280px, 高450px
- 标题栏: 高40px, 显示"可选君主 <剧本名>"

**列表项设计**:
- 高度: 45px/项
- 选中状态: 金色边框+金色文字
- 悬停状态: 灰色背景
- 未选中: 深灰背景+白色文字

**滚动功能**:
- 支持鼠标滚轮滚动
- 显示滚动条(右侧8px宽)
- 滚动区域: contentH - 10

**数据结构**:
```javascript
{
    id: 1,
    name: '曹操',
    force: 85,        // 武力
    iq: 95,           // 智力
    armyType: '骑兵', // 兵种
    cities: 3,        // 城池数
    generals: 10      // 将领数
}
```

#### 3.3.2 右侧战略地图

**地图显示**:
- 位置: X=420, Y=140
- 尺寸: 宽530px, 高450px
- 底图: sanguoditu.png(拉伸填充)
- 边框: 金色, 选中君主时加粗

**城池标记系统**:

38座城池精确坐标(基于地图比例):

```javascript
{
    '洛阳': { x: 310, y: 205 },
    '长安': { x: 275, y: 150 },
    '许昌': { x: 370, y: 200 },
    '成都': { x: 110, y: 320 },
    '建业': { x: 505, y: 275 },
    // ... 共38座
}
```

**城池图标**:

使用SVG图标区分归属:

| 类型 | 图标文件 | 颜色 | 说明 |
|------|----------|------|------|
| 友方 | city-friendly-classic.svg | 蓝色(#4682B4) | 当前选中君主的城池 |
| 敌方 | city-enemy-classic.svg | 红色(#DC143C) | 其他势力城池 |
| 中立 | city-neutral-classic.svg | 灰色(#C0C0C0) | 空城(未被占领) |

**选中高亮效果**:
- 金色脉冲动画(周期约2秒)
- 外圈: 20px半径, 0.6透明度
- 内圈: 16px半径, 0.3透明度
- 脉冲幅度: ±30%

### 3.4 视觉设计

#### 3.4.1 配色方案

- **背景**: 深蓝渐变(与剧本选择界面一致)
- **列表背景**: rgba(25, 25, 45, 0.85)
- **选中色**: 金色(#c9a050, #ffd700)
- **友方色**: 蓝色系
- **敌方色**: 红色系
- **中立项**: 灰色系

#### 3.4.2 字体规范

- **标题**: 36px STKaiti (选择君主)
- **列表标题**: 16px Microsoft YaHei Bold
- **君主名称**: 16px Microsoft YaHei Bold
- **城池名称**: 12px Microsoft YaHei Bold + 阴影

### 3.5 技术实现

#### 3.5.1 核心类结构

```javascript
export class KingSelectScreen {
    constructor(engine) {
        this.engine = engine;
        this.eventBus = engine.eventBus;
        this.selectedKing = null;       // 当前选中君主
        this.availableKings = [];       // 可选君主列表
        this.periodData = null;         // 当前剧本数据
        this.cityOwnershipMap = {};     // 城池归属映射表
        this.cityCoordinates = {...};   // 38座城池坐标
        this.mapImage = null;           // 地图图片对象
        this.cityIcons = {...};         // 城池图标缓存
        this.particles = [];            // 粒子数组
        this._scrollY = 0;              // 列表滚动位置
        this._hoveredIndex = -1;        // 悬停索引
    }
    
    // 初始化
    _initMap()                    // 加载地图图片
    _initCityIcons()              // 加载城池图标
    _initCityCoordinates()        // 设置城池坐标
    _initParticles()              // 初始化粒子
    _buildCityOwnershipMap()      // 构建归属映射
    
    // 数据设置
    setPeriod(periodData)         // 设置当前剧本
    setAvailableKings(kings)      // 设置可选君主
    
    // 交互
    onSelectKing(king)            // 选择君主
    onConfirm()                   // 确认开始游戏
    onBack()                      // 返回剧本选择
    onWheel(deltaY)               // 鼠标滚轮
    
    // 更新与渲染
    update(deltaTime)
    render(ctx)
}
```

#### 3.5.2 城池归属判定逻辑

```javascript
_buildCityOwnershipMap() {
    this.cityOwnershipMap = {};
    if (this.periodData && this.periodData.cities) {
        this.periodData.cities.forEach(city => {
            // owner为空字符串表示未被占领
            this.cityOwnershipMap[city.name] = city.owner || '';
        });
    }
}

// 绘制时判断归属
_drawCityIcon(ctx, x, y, cityName) {
    const owner = this.cityOwnershipMap[cityName];
    let cityType = 'enemy';  // 默认敌方
    
    if (!owner) {
        cityType = 'neutral';  // 空城
    } else if (this.selectedKing && owner === this.selectedKing.name) {
        cityType = 'friendly'; // 友方
    }
    
    // 绘制对应图标
    this._drawCityIconByType(ctx, x, y, cityType);
}
```

#### 3.5.3 地图坐标转换

```javascript
// 将数据坐标转换为屏幕坐标
_mapToScreen(dataX, dataY, mapW, mapH) {
    const screenX = infoX + (dataX / this.mapImage.width) * infoW;
    const screenY = infoY + (dataY / this.mapImage.height) * infoH;
    return { x: screenX, y: screenY };
}
```

#### 3.5.4 滚动列表实现

```javascript
_renderKingList(ctx) {
    // 1. 绘制列表背景和标题栏
    
    // 2. 计算可见区域
    const totalContentHeight = kings.length * itemHeight;
    const maxScroll = Math.max(0, totalContentHeight - contentH);
    this._scrollY = Math.max(0, Math.min(this._scrollY, maxScroll));
    
    // 3. 设置裁剪区域(只绘制可见部分)
    ctx.save();
    ctx.beginPath();
    ctx.rect(listX, contentY, contentWidth, contentH);
    ctx.clip();
    
    // 4. 绘制可见的列表项
    kings.forEach((king, index) => {
        const itemY = contentY + index * itemHeight - this._scrollY;
        // 只绘制在可视范围内的项
        if (itemY + itemHeight >= contentY && itemY <= contentY + contentH) {
            // 绘制列表项...
        }
    });
    
    ctx.restore();
    
    // 5. 绘制滚动条
    if (totalContentHeight > contentH) {
        const scrollbarHeight = (contentH / totalContentHeight) * contentH;
        const scrollbarY = contentY + (this._scrollY / maxScroll) * (contentH - scrollbarHeight);
        // 绘制滚动条...
    }
}
```

#### 3.5.5 高亮动画

```javascript
// 计算脉冲动画值
const pulsePhase = (this.animationTime * 3) % (Math.PI * 2);
const pulseScale = 1 + Math.sin(pulsePhase) * 0.3;
const pulseOpacity = 0.6 - Math.sin(pulsePhase) * 0.2;

// 绘制外圈脉冲
ctx.beginPath();
ctx.arc(screenX, screenY, 20 * pulseScale, 0, Math.PI * 2);
ctx.strokeStyle = `rgba(255, 215, 0, ${pulseOpacity})`;
ctx.lineWidth = 3;
ctx.stroke();

// 绘制内圈光晕
ctx.beginPath();
ctx.arc(screenX, screenY, 16, 0, Math.PI * 2);
ctx.fillStyle = `rgba(255, 215, 0, ${0.3 + Math.sin(pulsePhase) * 0.2})`;
ctx.fill();
```

### 3.6 交互设计

#### 3.6.1 鼠标操作

| 操作 | 区域 | 响应 |
|------|------|------|
| 移动 | 君主列表 | 更新悬停索引,高亮列表项 |
| 点击 | 君主列表项 | 选中对应君主,更新地图高亮 |
| 滚轮 | 君主列表 | 滚动列表内容 |
| 点击 | 返回按钮 | 返回剧本选择界面 |
| 点击 | 开始游戏按钮 | 确认选择,进入战略地图 |

#### 3.6.2 事件系统

**触发事件**:
- `king.selected`: 选择君主时触发
  - 参数: kingData
- `screen.change`: 切换界面
  - 参数: 'StrategyMap' 或 'PeriodSelect'

### 3.7 数据流

```
剧本选择界面
    ↓ (period.selected事件)
    传递 periodData {
        id, name, year,
        cities: [...],    // 38座城池及归属
        rulers: [...]     // 该时期可选君主
    }
    ↓
君主选择界面.setPeriod(periodData)
    ↓
构建cityOwnershipMap
    ↓
渲染地图(根据归属显示不同颜色)
    ↓
玩家选择君主
    ↓
高亮该君主的城池
    ↓
点击开始游戏
    ↓ (king.selected事件)
进入战略地图
```

---

## 四、界面设计规范

### 4.1 通用设计原则

1. **一致性**:
   - 所有界面使用统一的配色方案(深蓝背景+金色强调)
   - 按钮样式统一
   - 字体规范统一

2. **视觉层次**:
   - 背景(深) → 面板(中) → 内容(浅)
   - 选中状态使用金色高亮
   - 悬停状态使用发光效果

3. **反馈及时**:
   - 悬停立即显示高亮
   - 点击立即响应
   - 状态变化有动画过渡

4. **信息密度**:
   - 避免信息过载
   - 重要信息突出显示
   - 次要信息适当弱化

### 4.2 色彩系统

**主色调**:
- 背景深色: #0a0a1a
- 面板深色: rgba(25, 25, 45, 0.85)
- 金色强调: #c9a050, #ffd700
- 白色文字: #ffffff, #cccccc
- 灰色文字: #888888

**状态色**:
- 成功/友方: 蓝色系
- 警告/敌方: 红色系
- 中性: 灰色系

### 4.3 字体规范

**中文字体**:
- 标题: STKaiti, KaiTi, SimKai (楷体)
- 正文: Microsoft YaHei (微软雅黑)

**字号**:
- 大标题: 36-42px
- 小标题: 16-20px
- 正文: 14-16px
- 辅助文字: 12px

### 4.4 动画规范

**缓动函数**:
- 悬停效果: linear
- 过渡动画: ease-out
- 脉冲动画: sin wave

**持续时间**:
- 即时反馈: 0ms
- 快速过渡: 100-200ms
- 标准过渡: 300ms
- 慢速动画: 1000ms+

---

## 五、技术要点

### 5.1 Canvas渲染优化

1. **分层渲染**: 背景 → 粒子 → UI元素
2. **裁剪区域**: 列表滚动使用clip()
3. **状态缓存**: 避免重复计算
4. **图像预加载**: 异步加载地图和图标

### 5.2 事件处理

1. **边界检测**: 精确计算点击区域
2. **事件冒泡**: 正确处理层级关系
3. **节流控制**: 滚轮事件适当节流

### 5.3 响应式设计

1. **固定分辨率**: 1024x768(游戏标准分辨率)
2. **相对布局**: 元素使用相对位置
3. **比例缩放**: 地图自适应面板尺寸

---

## 六、扩展性设计

### 6.1 新增时期

如需添加新的历史时期:

1. 在`PeriodSelectScreen.periods`数组中添加新条目
2. 创建对应的SVG背景图
3. 在`dat.xml`中配置该时期的城池和君主数据

### 6.2 新增君主

如需添加新的君主:

1. 在`dat.xml`中配置君主数据
2. 更新对应时期的`rulers`数组
3. 君主将自动显示在君主选择列表中

### 6.3 新增城池

如需添加新的城池:

1. 在`KingSelectScreen.cityCoordinates`中添加坐标
2. 在`dat.xml`中配置城池数据
3. 更新时期配置中的城池归属

---

## 七、相关文件

### 7.1 界面文件

- `src/ui/screens/PeriodSelectScreen.js` - 剧本选择界面
- `src/ui/screens/KingSelectScreen.js` - 君主选择界面
- `src/ui/screens/MainMenuScreen.js` - 主菜单界面
- `src/ui/screens/StrategyMapScreen.js` - 战略地图界面

### 7.2 资源文件

- `src/assets/sanguoditu.png` - 战略地图底图
- `src/assets/icons/city-friendly-classic.svg` - 友方城池图标
- `src/assets/icons/city-enemy-classic.svg` - 敌方城池图标
- `src/assets/icons/city-neutral-classic.svg` - 中立城池图标
- `src/assets/images/periods/period_*.svg` - 时期背景图(1-4)

### 7.3 数据文件

- `data/dat.xml` - 游戏数据配置(包含时期、城池、君主数据)

---

## 八、更新记录

- **2026-02-15**: 创建本文档, 详细描述剧本选择和君主选择界面
- **2026-02-13**: 完成君主选择界面开发(战略地图+城池标记)
- **2026-02-12**: 完成剧本选择界面开发(4个时期卡片)

---

*文档版本: 1.0*  
*创建日期: 2026-02-15*  
*作者: 开发团队*
