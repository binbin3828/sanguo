# 三国霸业 - 内政系统详细设计文档

## 文档说明

本文档详细描述《三国霸业》内政系统的所有指令逻辑、数值计算和交互流程。

---

## 一、内政指令总览

内政指令是城市发展的核心，通过消耗武将体力来提升城市各项属性。

### 1.1 指令分类

| 指令ID | 指令名称 | 消耗体力 | 主要效果 | 冷却时间 |
|--------|----------|----------|----------|----------|
| 0 | 无操作(NOP) | 4 | 恢复武将 | 立即 |
| 1 | 开垦(ASSART) | 4 | 增加农业 | 1个月 |
| 2 | 招商(ACCRACTBUSINESS) | 4 | 增加商业 | 1个月 |
| 3 | 搜寻(SEARCH) | 4 | 随机事件 | 立即 |
| 4 | 治理(FATHER) | 4 | 随机恢复 | 立即 |
| 5 | 出巡(INSPECTION) | 4 | 增加民忠 | 1个月 |
| 6 | 招降(SURRENDER) | 4 | 招降俘虏 | 立即 |
| 7 | 处斩(KILL) | 4 | 处决俘虏 | 立即 |
| 8 | 流放(BANISH) | 4 | 释放俘虏 | 立即 |
| 9 | 赏赐(LARGESS) | 4 | 增加忠诚 | 立即 |
| 10 | 没收(CONFISCATE) | 4 | 夺取道具 | 立即 |
| 11 | 交易(EXCHANGE) | 4 | 买卖物资 | 立即 |
| 12 | 宴请(TREAT) | 4 | 恢复体力 | 立即 |
| 13 | 输送(TRANSPORTATION) | 4 | 物资运输 | 1个月 |
| 14 | 移动(MOVE) | 4 | 武将调动 | 立即 |

### 1.2 指令常量定义

```typescript
// 内政指令常量
const ORDER_NOP = 0;                  // 无操作
const ORDER_ASSART = 1;               // 开垦
const ORDER_ACCRACTBUSINESS = 2;      // 招商
const ORDER_SEARCH = 3;               // 搜寻
const ORDER_FATHER = 4;               // 治理
const ORDER_INSPECTION = 5;           // 出巡
const ORDER_SURRENDER = 6;            // 招降
const ORDER_KILL = 7;                 // 处斩
const ORDER_BANISH = 8;               // 流放
const ORDER_LARGESS = 9;              // 赏赐
const ORDER_CONFISCATE = 10;          // 没收
const ORDER_EXCHANGE = 11;            // 交易
const ORDER_TREAT = 12;               // 宴请
const ORDER_TRANSPORTATION = 13;      // 输送
const ORDER_MOVE = 14;                // 移动

// 指令消耗体力
const ORDER_CONSUME_THEW = 4;         // 所有内政指令消耗4点体力

// 指令冷却时间（月）
const ORDER_COOLDOWN_IMMEDIATE = 0;   // 立即执行
const ORDER_COOLDOWN_ONE_MONTH = 1;   // 1个月冷却
```

---

## 二、各指令详细逻辑

### 2.1 开垦（ASSART）

**功能说明**：开发城市农业，增加粮食产量上限。

**执行流程**：
1. 检查当前农业开发度是否已达上限
2. 若未满，增加农业开发度
3. 返回武将到城中

**数值计算**：
```typescript
function calculateFarmingIncrease(person: PersonType, city: CityType): number {
  // 基础增量
  let baseIncrease = 10 + Math.random() * (person.iq * 2);
  
  // 不能超过上限
  let maxIncrease = city.farmingLimit - city.farming;
  let actualIncrease = Math.min(baseIncrease, maxIncrease);
  
  return actualIncrease;
}
```

**结果提示**：
- 成功："农业开发度变为XXX (+XX)"
- 已达上限："已达农业上限"

---

### 2.2 招商（ACCRACTBUSINESS）

**功能说明**：发展城市商业，增加金钱收入上限。

**执行流程**：
1. 检查当前商业开发度是否已达上限
2. 若未满，增加商业开发度
3. 返回武将到城中

**数值计算**：
```typescript
function calculateCommerceIncrease(person: PersonType, city: CityType): number {
  // 基础增量
  let baseIncrease = 10 + Math.random() * (person.iq * 2);
  
  // 不能超过上限
  let maxIncrease = city.commerceLimit - city.commerce;
  let actualIncrease = Math.min(baseIncrease, maxIncrease);
  
  return actualIncrease;
}
```

**结果提示**：
- 成功："商业开发度变为XXX (+XX)"
- 已达上限："已达商业上限"

---

### 2.3 搜寻（SEARCH）

**功能说明**：在城中搜索，可能发现隐藏武将、道具或获得资源。

**执行流程**：
1. 随机决定搜索类型（共4种结果）
2. 根据武将智力决定成功率
3. 执行对应逻辑
4. 显示搜索结果

**随机事件类型**（概率均等）：

| 类型 | 概率 | 说明 |
|------|------|------|
| 一无所获 | 25% | 什么也没找到 |
| 发现人才/道具 | 25% | 搜索武将或道具 |
| 获得金钱 | 25% | 随机获得金钱 |
| 获得粮食 | 25% | 随机获得粮食 |

**发现人才逻辑**：
```typescript
function searchForPerson(person: PersonType, city: CityType): SearchResult {
  // 1. 获取城中在野武将列表
  let availablePersons = getCityOutPersons(city.id);
  
  if (availablePersons.length === 0) return { type: 'nothing' };
  
  // 2. 随机选择一个
  let targetPerson = randomSelect(availablePersons);
  
  // 3. 检查是否有伯乐关系
  let searchCondition = getSearchCondition(targetPerson.id);
  let success = false;
  
  if (searchCondition.bole - 1 === person.id) {
    // 伯乐必定成功
    success = true;
  } else if (searchCondition.bole === 0) {
    // 无伯乐，按智力判定
    let chance = Math.random() * 110;
    if (chance < person.iq) {
      success = true;
    }
  }
  
  if (success) {
    // 4. 成功招入
    targetPerson.belong = person.belong;
    targetPerson.devotion = 70 + Math.random() * 30;
    addPersonToCity(city.id, targetPerson.id);
    return { 
      type: 'person', 
      personId: targetPerson.id,
      message: getRandomDialog('person_joined')
    };
  }
  
  return { type: 'nothing', message: "听说城中有位贤者，可惜臣未能访到。" };
}
```

**发现道具逻辑**：
```typescript
function searchForTool(person: PersonType, city: CityType): SearchResult {
  // 1. 获取城中未分配道具列表
  let availableTools = getCityDispGoods(city.id);
  
  if (availableTools.length === 0) return { type: 'nothing' };
  
  // 2. 随机选择一个
  let targetTool = randomSelect(availableTools);
  
  // 3. 检查使用条件
  let toolCondition = getToolCondition(targetTool.id);
  
  if (toolCondition.bole === 0 || toolCondition.bole - 1 === person.id) {
    // 获得道具
    setGoods(city.id, targetTool.id);
    return { 
      type: 'tool', 
      toolId: targetTool.id,
      message: `城中找到 ${getToolName(targetTool.id)}`
    };
  }
  
  return { type: 'nothing' };
}
```

**获得金钱**：
```typescript
function searchForMoney(person: PersonType, city: CityType): SearchResult {
  let amount = 10 + Math.random() * (person.iq * 2);
  city.money = Math.min(city.money + amount, MAX_MONEY);
  return { type: 'money', amount: amount };
}
```

**获得粮食**：
```typescript
function searchForFood(person: PersonType, city: CityType): SearchResult {
  let amount = 10 + Math.random() * (person.iq * 2);
  city.food = Math.min(city.food + amount, MAX_FOOD);
  return { type: 'food', amount: amount };
}
```

---

### 2.4 治理（FATHER）

**功能说明**：治理城市，随机恢复城市状态或增加防灾。

**执行流程**：
1. 检查城市当前状态
2. 若有灾害，恢复为正常
3. 若无灾害，增加防灾值
4. 返回武将

**状态恢复优先级**：
```typescript
function fatherCity(person: PersonType, city: CityType): FatherResult {
  if (city.state !== STATE_NORMAL) {
    // 优先恢复灾害状态
    city.state = STATE_NORMAL;
    let calamityIncrease = 5 + Math.random() * 10;
    city.avoidCalamity = Math.min(city.avoidCalamity + calamityIncrease, 100);
    return { 
      type: 'recover', 
      message: `城市状态正常，防灾变为 ${Math.floor(city.avoidCalamity)}`
    };
  } else {
    // 增加防灾
    let increase = 5 + Math.random() * 5;
    let oldValue = city.avoidCalamity;
    city.avoidCalamity = Math.min(city.avoidCalamity + increase, 100);
    
    if (city.avoidCalamity >= 100) {
      return { type: 'max', message: "防灾已达上限" };
    }
    
    return { 
      type: 'increase', 
      increase: city.avoidCalamity - oldValue,
      current: city.avoidCalamity
    };
  }
}
```

---

### 2.5 出巡（INSPECTION）

**功能说明**：君主出巡，增加民忠。

**执行流程**：
1. 计算民忠增量
2. 更新城市民忠
3. 返回武将

**数值计算**：
```typescript
function inspectionCity(person: PersonType, city: CityType): InspectionResult {
  // 基础增量
  let baseIncrease = 5 + Math.random() * 10;
  
  // 君主身份有额外加成
  if (person.belong === person.id + 1) {
    baseIncrease *= 1.5;
  }
  
  let oldDevotion = city.peopleDevotion;
  city.peopleDevotion = Math.min(city.peopleDevotion + baseIncrease, 100);
  
  return {
    increase: city.peopleDevotion - oldDevotion,
    current: city.peopleDevotion
  };
}
```

---

### 2.6 招降（SURRENDER）

**功能说明**：对俘虏进行招降，使其归顺。

**执行流程**：
1. 显示城中俘虏列表
2. 选择目标俘虏
3. 计算成功率
4. 执行结果

**成功率计算**：
```typescript
function calculateSurrenderRate(
  executor: PersonType, 
  target: PersonType
): number {
  // 基础成功率 = 执行者IQ - 目标IQ + 50
  let baseRate = executor.iq - target.iq + 50;
  
  // 根据性格调整
  let characterMod = 0;
  switch (target.character) {
    case CHARACTER_LOYALISM:  // 忠义
      characterMod = 5;
      break;
    case CHARACTER_IDEAL:     // 大志
      characterMod = 20;
      break;
    case CHARACTER_AVARICE:   // 贪财
      characterMod = 30;
      break;
    case CHARACTER_DREAD:     // 怕死
      characterMod = 60;
      break;
    case CHARACTER_TEMERITY:  // 卤莽
      characterMod = 15;
      break;
  }
  
  // 忠诚度影响
  if (target.devotion > 60) {
    return 0; // 忠诚度太高，无法招降
  }
  
  // 最终成功率 = 基础率 / 性格系数
  let finalRate = baseRate / characterMod;
  
  return Math.max(0, Math.min(100, finalRate));
}
```

**执行逻辑**：
```typescript
function executeSurrender(
  executor: PersonType,
  target: PersonType,
  city: CityType
): SurrenderResult {
  // 1. 消耗忠诚度
  target.devotion = Math.max(0, target.devotion - target.devotion / 10);
  
  // 2. 判定是否成功
  let rate = calculateSurrenderRate(executor, target);
  let roll = Math.random() * 100;
  
  if (roll < rate) {
    // 3. 招降成功
    target.belong = executor.belong;
    target.devotion = 40 + Math.random() * 40;
    addPersonToCity(city.id, target.id);
    
    return {
      success: true,
      message: `${getPersonName(target.id)} 我愿加入，为主公效力！`,
      response: getRandomDialog('surrender_success')
    };
  } else {
    // 4. 招降失败
    return {
      success: false,
      message: getRandomDialog('surrender_fail')
    };
  }
}
```

**失败时武将台词**（随机）：
- "哼！我岂是贪生怕死之徒！"
- "你还是少费唇舌，我是不会背信弃义的！"
- "就凭你要我归降，笑话！"

---

### 2.7 处斩（KILL）

**功能说明**：处决俘虏，彻底移除该武将。

**执行流程**：
1. 显示俘虏列表
2. 选择目标
3. 确认处决
4. 移除武将

**注意事项**：
- 处斩后武将从游戏中永久移除
- 君主无法被处斩
- 处斩可能影响其他武将忠诚度

---

### 2.8 流放（BANISH）

**功能说明**：释放俘虏，使其成为在野武将。

**执行流程**：
1. 显示俘虏列表
2. 选择目标
3. 确认释放
4. 改变武将归属为0（在野）

**效果**：
- 武将变为在野状态
- 可被其他势力招募

---

### 2.9 赏赐（LARGESS）

**功能说明**：赏赐武将，增加其忠诚度。

**执行流程**：
1. 选择目标武将
2. 选择赏赐类型（金钱/道具）
3. 执行赏赐
4. 增加忠诚度

**数值计算**：
```typescript
function calculateLargessEffect(type: string, value: number): number {
  switch (type) {
    case 'money':
      // 每100金钱增加1-3点忠诚
      return Math.floor(value / 100) * (1 + Math.random() * 2);
    case 'tool':
      // 道具根据价值增加10-30点忠诚
      return 10 + Math.random() * 20;
    default:
      return 0;
  }
}
```

---

### 2.10 没收（CONFISCATE）

**功能说明**：没收武将装备或城中道具。

**执行流程**：
1. 选择目标（武将/城中道具）
2. 选择具体道具
3. 执行没收
4. 降低武将忠诚度（如果是没收武将道具）

**忠诚度惩罚**：
```typescript
function confiscatePenalty(person: PersonType): number {
  // 没收道具降低10-20点忠诚
  let penalty = 10 + Math.random() * 10;
  person.devotion = Math.max(0, person.devotion - penalty);
  return penalty;
}
```

**武将反应台词**：
- "一片忠诚，竟遭此待遇……"
- "长此以往，人心难留……"
- "主公此举自有道理，我却无法理解……"

---

### 2.11 交易（EXCHANGE）

**功能说明**：用粮食换取金钱或反之。

**执行流程**：
1. 选择交易方向（买粮/卖粮）
2. 输入交易数量
3. 计算价格
4. 执行交易

**交易公式**：
```typescript
// 价格受市场影响，有波动
function calculateExchangeRate(city: CityType, type: 'buy' | 'sell'): number {
  let baseRate = 10; // 基础比例：10粮食 = 1金钱
  
  // 商业发展度影响价格
  let commerceFactor = city.commerce / city.commerceLimit;
  
  // 随机波动
  let fluctuation = 0.8 + Math.random() * 0.4; // 0.8 - 1.2
  
  if (type === 'buy') {
    // 买粮价格略高
    return Math.floor(baseRate * (1 + commerceFactor * 0.5) * fluctuation * 1.1);
  } else {
    // 卖粮价格略低
    return Math.floor(baseRate * (1 + commerceFactor * 0.5) * fluctuation * 0.9);
  }
}
```

---

### 2.12 宴请（TREAT）

**功能说明**：宴请武将，恢复其体力。

**执行流程**：
1. 选择目标武将
2. 确认宴请
3. 消耗金钱
4. 恢复体力

**恢复量**：
```typescript
function calculateTreatRecovery(person: PersonType): number {
  // 基础恢复50点
  let recovery = 50;
  
  // 不能超过最大值
  let maxThew = calculateMaxThew(person);
  let actualRecovery = Math.min(recovery, maxThew - person.thew);
  
  person.thew += actualRecovery;
  return actualRecovery;
}

// 最大体力公式
function calculateMaxThew(person: PersonType): number {
  return 100; // 基础最大体力100
}
```

**成本**：
- 每次宴请消耗100金钱

---

### 2.13 输送（TRANSPORTATION）

**功能说明**：将物资输送到其他城市。

**执行流程**：
1. 选择目标城市
2. 选择输送物资（金钱/粮食/兵力）
3. 确认数量
4. 执行输送（可能有风险）

**成功率**：
```typescript
function calculateTransportSuccess(): boolean {
  // 80%成功率
  return Math.random() * 100 < 80;
}
```

**风险事件**：
- 成功：物资送达目标城市
- 失败："途中遇到山贼，所输送物质被抢劫一空！"

**执行逻辑**：
```typescript
function executeTransport(
  executor: PersonType,
  sourceCity: CityType,
  targetCity: CityType,
  resources: Resources
): TransportResult {
  // 1. 扣除源城市资源
  sourceCity.food -= resources.food;
  sourceCity.money -= resources.money;
  sourceCity.mothballArms -= resources.arms;
  
  // 2. 判定是否成功
  if (calculateTransportSuccess()) {
    // 3. 成功送达
    targetCity.food += resources.food;
    targetCity.money += resources.money;
    targetCity.mothballArms += resources.arms;
    
    return {
      success: true,
      message: "物资运送完毕。"
    };
  } else {
    // 4. 被劫
    return {
      success: false,
      message: "途中遇到山贼，所输送物质被抢劫一空！"
    };
  }
}
```

---

### 2.14 移动（MOVE）

**功能说明**：调动武将到指定城市。

**执行流程**：
1. 选择目标武将
2. 选择目标城市
3. 检查移动条件
4. 执行移动

**移动条件**：
```typescript
function canMoveToCity(
  person: PersonType,
  targetCity: CityType,
  currentCity: CityType
): boolean {
  // 1. 不能移动到敌方城市
  if (targetCity.belong !== 0 && targetCity.belong !== person.belong) {
    return false;
  }
  
  // 2. 必须是相邻城市（需要检查道路连通性）
  if (!isCityConnected(currentCity.id, targetCity.id)) {
    return false;
  }
  
  return true;
}
```

**执行效果**：
- 武将从原城市移除
- 武将添加到目标城市
- 如果目标城市无归属，武将归属变为该武将所属势力

---

## 三、指令执行系统

### 3.1 指令队列机制

所有指令在月末统一执行，使用队列管理：

```typescript
interface OrderQueue {
  orders: OrderType[];  // 最大200条
  
  addOrder(order: OrderType): boolean;
  removeOrder(order: OrderType): void;
  executeAll(): void;
}
```

### 3.2 执行流程

```
玩家下达指令 → 验证条件 → 加入队列 → 月末执行 → 显示结果
```

### 3.3 月末结算流程

1. 遍历指令队列
2. 按指令类型调用对应驱动函数
3. 执行指令效果
4. 删除已执行指令
5. 更新城市/武将数据
6. 触发随机事件（灾害等）

---

## 四、城市状态系统

### 4.1 灾害系统

**灾害类型**：
- 饥荒：农业收益减半
- 旱灾：农业收益减半
- 水灾：商业收益减半
- 暴动：无法执行内政指令

**灾害触发**：
```typescript
function checkCalamity(city: CityType): void {
  // 每月初检查
  let roll = Math.random() * 100;
  let threshold = 100 - city.avoidCalamity; // 防灾越高，概率越低
  
  if (roll < threshold) {
    // 触发灾害
    let calamityType = Math.floor(Math.random() * 4) + 1;
    city.state = calamityType;
    
    // 通知玩家
    showCalamityNotice(city.id, calamityType);
  }
}
```

**灾害恢复**：
- 执行"治理"指令可恢复正常状态

### 4.2 资源自动增长

**每月自动增长**：
```typescript
function monthlyResourceGrowth(city: CityType): void {
  // 粮食增长 = 农业开发度 / 10
  let foodGrowth = city.farming / 10;
  city.food = Math.min(city.food + foodGrowth, MAX_FOOD);
  
  // 金钱增长 = 商业开发度 / 10
  let moneyGrowth = city.commerce / 10;
  city.money = Math.min(city.money + moneyGrowth, MAX_MONEY);
  
  // 人口增长
  let populationGrowth = Math.floor(city.population * 0.01);
  city.population = Math.min(city.population + populationGrowth, city.populationLimit);
}
```

---

## 五、交互流程设计

### 5.1 城市界面布局

```
┌─────────────────────────────────────┐
│  城市名称        归属: XXX          │
├─────────────────────────────────────┤
│  农业: XXX/XXX    商业: XXX/XXX    │
│  民忠: XXX        防灾: XXX        │
│  人口: XXX/XXX                      │
│  金钱: XXX       粮食: XXX         │
│  后备兵: XXX                        │
├─────────────────────────────────────┤
│  城中武将列表（可滚动）              │
├─────────────────────────────────────┤
│  内政 │ 外交 │ 军备 │ 状况          │
└─────────────────────────────────────┘
```

### 5.2 指令选择流程

```
点击城市 → 打开城市界面 → 选择指令类别 → 选择具体指令 → 选择执行武将 → 确认执行
```

### 5.3 武将选择界面

显示城中所有空闲武将（未下达指令）：
- 显示武将头像/名称
- 显示体力值
- 显示能力值

---

## 六、数据持久化

### 6.1 存档数据结构

```typescript
interface SaveData {
  version: number;              // 存档版本
  playerIndex: number;          // 玩家ID
  personCount: number;          // 武将数量
  playerKing: number;           // 玩家君主
  yearDate: number;             // 年份
  lookEnemy: boolean;           // 观看敌人
  lookMovie: boolean;           // 观看动画
  moveSpeed: boolean;           // 移动速度
  monthDate: number;            // 月份
  cityPos: CitySetType;         // 地图位置
  persons: PersonType[];        // 武将数据
  personsQueue: number[];       // 武将队列
  goodsQueue: number[];         // 道具队列
  fightersIdx: number[];        // 战斗索引
  fighters: Fighter[];          // 战斗数据
  orderQueue: OrderType[];      // 指令队列
  cities: CityType[];           // 城市数据
  randomSeed: number;           // 随机种子
}
```

---

*文档版本：1.0*  
*创建日期：2026-02-10*
